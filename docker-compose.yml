version: '3.8'

services:
  # ============================================
  # SQL SERVER - Database chính
  # ============================================
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: tutor_sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SQL_SA_PASSWORD}
      - MSSQL_PID=Developer
    volumes:
      - sqlserver_data:/var/opt/mssql
      - ./TutorCenterBackend/complete_db_setup.sql:/docker-entrypoint-initdb.d/complete_db_setup.sql:ro
    networks:
      - tutor_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/1433' || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 30s

  # ============================================
  # MINIO - Object Storage (S3-compatible)
  # ============================================
  minio:
    image: minio/minio:latest
    container_name: tutor_minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
      - ./minio-cors-config.json:/config/cors.json:ro
    networks:
      - tutor_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 3s
      retries: 3

  # MinIO Client - Tạo bucket mặc định
  minio-mc:
    image: minio/mc
    container_name: tutor_minio_mc
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - tutor_network
    entrypoint: >
      /bin/sh -c "
      /usr/bin/mc alias set myminio http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
      /usr/bin/mc mb myminio/${MINIO_DEFAULT_BUCKET} --ignore-existing;
      /usr/bin/mc anonymous set public myminio/${MINIO_DEFAULT_BUCKET};
      exit 0;
      "

  # ============================================
  # BACKEND - .NET 8 API
  # ============================================
  backend:
    build:
      context: ./TutorCenterBackend
      dockerfile: Dockerfile
    container_name: tutor_backend
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      # Database
      - ConnectionStrings__DefaultConnection=Server=sqlserver,1433;Database=${SQL_DATABASE};User Id=sa;Password=${SQL_SA_PASSWORD};TrustServerCertificate=True;
      # S3 Storage
      - S3Storage__ServiceUrl=http://minio:9000
      - S3Storage__PublicUrl=${S3_PUBLIC_URL}
      - S3Storage__AccessKey=${MINIO_ROOT_USER}
      - S3Storage__SecretKey=${MINIO_ROOT_PASSWORD}
      - S3Storage__DefaultBucket=${MINIO_DEFAULT_BUCKET}
      - S3Storage__Region=us-east-1
      # JWT
      - Jwt__Key=${JWT_SECRET_KEY}
      - Jwt__Issuer=${JWT_ISSUER}
      - Jwt__Audience=${JWT_AUDIENCE}
      - Jwt__ExpiresMinutes=${JWT_EXPIRES_MINUTES}
      - Jwt__RefreshTokenDays=${JWT_REFRESH_TOKEN_DAYS}
      # OTP
      - Otp__ExpiresMinutes=${OTP_EXPIRES_MINUTES}
      # Email (Resend)
      - Resend__ApiKey=${RESEND_API_KEY}
      - Resend__FromEmail=${RESEND_FROM_EMAIL}
      - Resend__FromName=${RESEND_FROM_NAME}
      # SMTP (Alternative)
      - Smtp__Host=${SMTP_HOST}
      - Smtp__Port=${SMTP_PORT}
      - Smtp__Username=${SMTP_USERNAME}
      - Smtp__Password=${SMTP_PASSWORD}
      - Smtp__From=${SMTP_FROM}
      - Smtp__EnableSsl=${SMTP_ENABLE_SSL}
      # AI Provider
      - AIProvider__Provider=${AI_PROVIDER}
      - AIProvider__GeminiApiKey=${GEMINI_API_KEY}
      - AIProvider__Model=${AI_MODEL}
      - AIProvider__MaxTokens=${AI_MAX_TOKENS}
      - AIProvider__Temperature=${AI_TEMPERATURE}
      - AIProvider__TimeoutSeconds=${AI_TIMEOUT_SECONDS}
      # Document Processing
      - DocumentProcessing__MaxFileSizeMB=${DOC_MAX_FILE_SIZE_MB}
      - DocumentProcessing__AllowedExtensions__0=${DOC_ALLOWED_EXTENSIONS}
      - DocumentProcessing__MaxTextLength=${DOC_MAX_TEXT_LENGTH}
      - DocumentProcessing__EnableBackgroundProcessing=${DOC_ENABLE_BACKGROUND_PROCESSING}
      # VNPay
      - VNPay__TmnCode=${VNPAY_TMN_CODE}
      - VNPay__HashSecret=${VNPAY_HASH_SECRET}
      - VNPay__Url=${VNPAY_URL}
      - VNPay__ReturnUrl=${VNPAY_RETURN_URL}
      - VNPay__Version=${VNPAY_VERSION}
      - VNPay__Command=${VNPAY_COMMAND}
      - VNPay__CurrCode=${VNPAY_CURR_CODE}
      - VNPay__Locale=${VNPAY_LOCALE}
      # Mistral AI
      - MistralAI__ApiKey=${MISTRAL_API_KEY}
      - MistralAI__ModelOcr=${MISTRAL_MODEL_OCR}
      # External OCR
      - ExternalOcr__BaseUrl=${EXTERNAL_OCR_BASE_URL}
      - ExternalOcr__OcrEndpoint=${EXTERNAL_OCR_ENDPOINT}
      - ExternalOcr__TimeoutSeconds=${EXTERNAL_OCR_TIMEOUT_SECONDS}
    depends_on:
      sqlserver:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - tutor_network
    restart: unless-stopped

  # ============================================
  # FRONTEND - React/Vite Static Files
  # ============================================
  frontend:
    build:
      context: ./web_app
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL}
    container_name: tutor_frontend
    networks:
      - tutor_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:80/"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ============================================
  # NGINX - Reverse Proxy & Static Server
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: tutor_nginx
    ports:
      - "${NGINX_PORT}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/cors.conf:/etc/nginx/cors.conf:ro
    depends_on:
      - backend
      - frontend
      - minio
    networks:
      - tutor_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://127.0.0.1:80/health"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ============================================
  # NGROK - Public Internet Tunnel (Dev Only)
  # ============================================
  ngrok:
    image: ngrok/ngrok:latest
    container_name: tutor_ngrok
    command:
      - "http"
      - "nginx:80"
      - "--authtoken=${NGROK_AUTHTOKEN}"
      - "--log=stdout"
    depends_on:
      - nginx
    networks:
      - tutor_network
    restart: unless-stopped
    profiles:
      - dev

# ============================================
# NETWORKS
# ============================================
networks:
  tutor_network:
    driver: bridge

# ============================================
# VOLUMES - Persistent Data
# ============================================
volumes:
  sqlserver_data:
    driver: local
  minio_data:
    driver: local